(function(b){b.jgrid.extend({editCell:function(e,f,a){return this.each(function(){var c=this,q,m,n;if(!c.grid||c.p.cellEdit!==true){return}f=parseInt(f,10);c.p.selrow=c.rows[e].id;if(!c.p.knv){b(c).jqGrid("GridNav")}if(c.p.savedRow.length>0){if(a===true){if(e==c.p.iRow&&f==c.p.iCol){return}}b(c).jqGrid("saveCell",c.p.savedRow[0].id,c.p.savedRow[0].ic)}else{window.setTimeout(function(){b("#"+c.p.knv).attr("tabindex","-1").focus()},0)}q=c.p.colModel[f].name;if(q=="subgrid"||q=="cb"||q=="rn"){return}n=b("td:eq("+f+")",c.rows[e]);if(c.p.colModel[f].editable===true&&a===true&&!n.hasClass("not-editable-cell")){if(parseInt(c.p.iCol,10)>=0&&parseInt(c.p.iRow,10)>=0){b("td:eq("+c.p.iCol+")",c.rows[c.p.iRow]).removeClass("edit-cell ui-state-highlight");b(c.rows[c.p.iRow]).removeClass("selected-row ui-state-hover")}b(n).addClass("edit-cell ui-state-highlight");b(c.rows[e]).addClass("selected-row ui-state-hover");try{m=b.unformat(n,{rowId:c.rows[e].id,colModel:c.p.colModel[f]},f)}catch(p){m=b(n).html()}if(c.p.autoencode){m=b.jgrid.htmlDecode(m)}if(!c.p.colModel[f].edittype){c.p.colModel[f].edittype="text"}c.p.savedRow.push({id:e,ic:f,name:q,v:m});if(b.isFunction(c.p.formatCell)){var d=c.p.formatCell(c.rows[e].id,q,m,e,f);if(d!==undefined){m=d}}var o=b.extend({},c.p.colModel[f].editoptions||{},{id:e+"_"+q,name:q});var r=createEl(c.p.colModel[f].edittype,o,m,true,b.extend({},b.jgrid.ajaxOptions,c.p.ajaxSelectOptions||{}));if(b.isFunction(c.p.beforeEditCell)){c.p.beforeEditCell(c.rows[e].id,q,m,e,f)}b(n).html("").append(r).attr("tabindex","0");window.setTimeout(function(){b(r).focus()},0);b("input, select, textarea",n).bind("keydown",function(g){if(g.keyCode===27){if(b("input.hasDatepicker",n).length>0){if(b(".ui-datepicker").is(":hidden")){b(c).jqGrid("restoreCell",e,f)}else{b("input.hasDatepicker",n).datepicker("hide")}}else{b(c).jqGrid("restoreCell",e,f)}}if(g.keyCode===13){b(c).jqGrid("saveCell",e,f)}if(g.keyCode==9){if(!c.grid.hDiv.loading){if(g.shiftKey){b(c).jqGrid("prevCell",e,f)}else{b(c).jqGrid("nextCell",e,f)}}else{return false}}g.stopPropagation()});if(b.isFunction(c.p.afterEditCell)){c.p.afterEditCell(c.rows[e].id,q,m,e,f)}}else{if(parseInt(c.p.iCol,10)>=0&&parseInt(c.p.iRow,10)>=0){b("td:eq("+c.p.iCol+")",c.rows[c.p.iRow]).removeClass("edit-cell ui-state-highlight");b(c.rows[c.p.iRow]).removeClass("selected-row ui-state-hover")}n.addClass("edit-cell ui-state-highlight");b(c.rows[e]).addClass("selected-row ui-state-hover");if(b.isFunction(c.p.onSelectCell)){m=n.html().replace(/\&#160\;/ig,"");c.p.onSelectCell(c.rows[e].id,q,m,e,f)}}c.p.iCol=f;c.p.iRow=e})},saveCell:function(d,a){return this.each(function(){var D=this,K;if(!D.grid||D.p.cellEdit!==true){return}if(D.p.savedRow.length>=1){K=0}else{K=null}if(K!==null){var z=b("td:eq("+a+")",D.rows[d]),B,N,G=D.p.colModel[a],M=G.name,I=b.jgrid.jqID(M);switch(G.edittype){case"select":if(!G.editoptions.multiple){B=b("#"+d+"_"+I+">option:selected",D.rows[d]).val();N=b("#"+d+"_"+I+">option:selected",D.rows[d]).text()}else{var H=b("#"+d+"_"+I,D.rows[d]),J=[];B=b(H).val();if(B){B.join(",")}else{B=""}b("option:selected",H).each(function(g,f){J[g]=b(f).text()});N=J.join(",")}if(G.formatter){N=B}break;case"checkbox":var y=["Yes","No"];if(G.editoptions){y=G.editoptions.value.split(":")}B=b("#"+d+"_"+I,D.rows[d]).attr("checked")?y[0]:y[1];N=B;break;case"password":case"text":case"textarea":case"button":B=b("#"+d+"_"+I,D.rows[d]).val();N=B;break;case"custom":try{if(G.editoptions&&b.isFunction(G.editoptions.custom_value)){B=G.editoptions.custom_value(b(".customelement",z),"get");if(B===undefined){throw"e2"}else{N=B}}else{throw"e1"}}catch(e){if(e=="e1"){info_dialog(jQuery.jgrid.errors.errcap,"function 'custom_value' "+b.jgrid.edit.msg.nodefined,jQuery.jgrid.edit.bClose)}if(e=="e2"){info_dialog(jQuery.jgrid.errors.errcap,"function 'custom_value' "+b.jgrid.edit.msg.novalue,jQuery.jgrid.edit.bClose)}else{info_dialog(jQuery.jgrid.errors.errcap,e.message,jQuery.jgrid.edit.bClose)}}break}if(N!=D.p.savedRow[K].v){if(b.isFunction(D.p.beforeSaveCell)){var v=D.p.beforeSaveCell(D.rows[d].id,M,B,d,a);if(v){B=v}}var L=checkValues(B,a,D);if(L[0]===true){var E={};if(b.isFunction(D.p.beforeSubmitCell)){E=D.p.beforeSubmitCell(D.rows[d].id,M,B,d,a);if(!E){E={}}}if(b("input.hasDatepicker",z).length>0){b("input.hasDatepicker",z).datepicker("hide")}if(D.p.cellsubmit=="remote"){if(D.p.cellurl){var c={};if(D.p.autoencode){B=b.jgrid.htmlEncode(B)}c[M]=B;var A,C,F;F=D.p.prmNames;A=F.id;C=F.oper;c[A]=D.rows[d].id;c[C]=F.editoper;c=b.extend(E,c);b("#lui_"+D.p.id).show();D.grid.hDiv.loading=true;b.ajax(b.extend({url:D.p.cellurl,data:b.isFunction(D.p.serializeCellData)?D.p.serializeCellData(c):c,type:"POST",complete:function(f,g){b("#lui_"+D.p.id).hide();D.grid.hDiv.loading=false;if(g=="success"){if(b.isFunction(D.p.afterSubmitCell)){var h=D.p.afterSubmitCell(f,c.id,M,B,d,a);if(h[0]===true){b(z).empty();b(D).jqGrid("setCell",D.rows[d].id,a,N,false,false,true);b(z).addClass("dirty-cell");b(D.rows[d]).addClass("edited");if(b.isFunction(D.p.afterSaveCell)){D.p.afterSaveCell(D.rows[d].id,M,B,d,a)}D.p.savedRow.splice(0,1)}else{info_dialog(b.jgrid.errors.errcap,h[1],b.jgrid.edit.bClose);b(D).jqGrid("restoreCell",d,a)}}else{b(z).empty();b(D).jqGrid("setCell",D.rows[d].id,a,N,false,false,true);b(z).addClass("dirty-cell");b(D.rows[d]).addClass("edited");if(b.isFunction(D.p.afterSaveCell)){D.p.afterSaveCell(D.rows[d].id,M,B,d,a)}D.p.savedRow.splice(0,1)}}},error:function(g,f){b("#lui_"+D.p.id).hide();D.grid.hDiv.loading=false;if(b.isFunction(D.p.errorCell)){D.p.errorCell(g,f);b(D).jqGrid("restoreCell",d,a)}else{info_dialog(b.jgrid.errors.errcap,g.status+" : "+g.statusText+"<br/>"+f,b.jgrid.edit.bClose);b(D).jqGrid("restoreCell",d,a)}}},b.jgrid.ajaxOptions,D.p.ajaxCellOptions||{}))}else{try{info_dialog(b.jgrid.errors.errcap,b.jgrid.errors.nourl,b.jgrid.edit.bClose);b(D).jqGrid("restoreCell",d,a)}catch(e){}}}if(D.p.cellsubmit=="clientArray"){b(z).empty();b(D).jqGrid("setCell",D.rows[d].id,a,N,false,false,true);b(z).addClass("dirty-cell");b(D.rows[d]).addClass("edited");if(b.isFunction(D.p.afterSaveCell)){D.p.afterSaveCell(D.rows[d].id,M,B,d,a)}D.p.savedRow.splice(0,1)}}else{try{window.setTimeout(function(){info_dialog(b.jgrid.errors.errcap,B+" "+L[1],b.jgrid.edit.bClose)},100);b(D).jqGrid("restoreCell",d,a)}catch(e){}}}else{b(D).jqGrid("restoreCell",d,a)}}if(b.browser.opera){b("#"+D.p.knv).attr("tabindex","-1").focus()}else{window.setTimeout(function(){b("#"+D.p.knv).attr("tabindex","-1").focus()},0)}})},restoreCell:function(d,a){return this.each(function(){var c=this,j;if(!c.grid||c.p.cellEdit!==true){return}if(c.p.savedRow.length>=1){j=0}else{j=null}if(j!==null){var e=b("td:eq("+a+")",c.rows[d]);if(b.isFunction(b.fn.datepicker)){try{b("input.hasDatepicker",e).datepicker("hide")}catch(i){}}b(e).empty().attr("tabindex","-1");b(c).jqGrid("setCell",c.rows[d].id,a,c.p.savedRow[j].v,false,false,true);if(b.isFunction(c.p.afterRestoreCell)){c.p.afterRestoreCell(c.rows[d].id,c.p.savedRow[j].v,d,a)}c.p.savedRow.splice(0,1)}window.setTimeout(function(){b("#"+c.p.knv).attr("tabindex","-1").focus()},0)})},nextCell:function(d,a){return this.each(function(){var c=this,g=false;if(!c.grid||c.p.cellEdit!==true){return}for(var h=a+1;h<c.p.colModel.length;h++){if(c.p.colModel[h].editable===true){g=h;break}}if(g!==false){b(c).jqGrid("editCell",d,g,true)}else{if(c.p.savedRow.length>0){b(c).jqGrid("saveCell",d,a)}}})},prevCell:function(d,a){return this.each(function(){var c=this,g=false;if(!c.grid||c.p.cellEdit!==true){return}for(var h=a-1;h>=0;h--){if(c.p.colModel[h].editable===true){g=h;break}}if(g!==false){b(c).jqGrid("editCell",d,g,true)}else{if(c.p.savedRow.length>0){b(c).jqGrid("saveCell",d,a)}}})},GridNav:function(){return this.each(function(){var h=this;if(!h.grid||h.p.cellEdit!==true){return}h.p.knv=h.p.id+"_kn";var i=b("<span style='width:0px;height:0px;background-color:black;' tabindex='0'><span tabindex='-1' style='width:0px;height:0px;background-color:grey' id='"+h.p.knv+"'></span></span>"),k,l;b(i).insertBefore(h.grid.cDiv);b("#"+h.p.knv).focus().keydown(function(c){l=c.keyCode;if(h.p.direction=="rtl"){if(l==37){l=39}else{if(l==39){l=37}}}switch(l){case 38:if(h.p.iRow-1>=0){j(h.p.iRow-1,h.p.iCol,"vu");b(h).jqGrid("editCell",h.p.iRow-1,h.p.iCol,false)}break;case 40:if(h.p.iRow+1<=h.rows.length-1){j(h.p.iRow+1,h.p.iCol,"vd");b(h).jqGrid("editCell",h.p.iRow+1,h.p.iCol,false)}break;case 37:if(h.p.iCol-1>=0){k=a(h.p.iCol-1,"lft");j(h.p.iRow,k,"h");b(h).jqGrid("editCell",h.p.iRow,k,false)}break;case 39:if(h.p.iCol+1<=h.p.colModel.length-1){k=a(h.p.iCol+1,"rgt");j(h.p.iRow,k,"h");b(h).jqGrid("editCell",h.p.iRow,k,false)}break;case 13:if(parseInt(h.p.iCol,10)>=0&&parseInt(h.p.iRow,10)>=0){b(h).jqGrid("editCell",h.p.iRow,h.p.iCol,true)}break}return false});function j(v,x,w){if(w.substr(0,1)=="v"){var s=b(h.grid.bDiv)[0].clientHeight,u=b(h.grid.bDiv)[0].scrollTop,t=h.rows[v].offsetTop+h.rows[v].clientHeight,d=h.rows[v].offsetTop;if(w=="vd"){if(t>=s){b(h.grid.bDiv)[0].scrollTop=b(h.grid.bDiv)[0].scrollTop+h.rows[v].clientHeight}}if(w=="vu"){if(d<u){b(h.grid.bDiv)[0].scrollTop=b(h.grid.bDiv)[0].scrollTop-h.rows[v].clientHeight}}}if(w=="h"){var e=b(h.grid.bDiv)[0].clientWidth,f=b(h.grid.bDiv)[0].scrollLeft,g=h.rows[v].cells[x].offsetLeft+h.rows[v].cells[x].clientWidth,c=h.rows[v].cells[x].offsetLeft;if(g>=e+parseInt(f,10)){b(h.grid.bDiv)[0].scrollLeft=b(h.grid.bDiv)[0].scrollLeft+h.rows[v].cells[x].clientWidth}else{if(c<f){b(h.grid.bDiv)[0].scrollLeft=b(h.grid.bDiv)[0].scrollLeft-h.rows[v].cells[x].clientWidth}}}}function a(c,f){var d,e;if(f=="lft"){d=c+1;for(e=c;e>=0;e--){if(h.p.colModel[e].hidden!==true){d=e;break}}}if(f=="rgt"){d=c-1;for(e=c;e<h.p.colModel.length;e++){if(h.p.colModel[e].hidden!==true){d=e;break}}}return d}})},getChangedCells:function(d){var a=[];if(!d){d="all"}this.each(function(){var c=this,f;if(!c.grid||c.p.cellEdit!==true){return}b(c.rows).each(function(h){var e={};if(b(this).hasClass("edited")){b("td",this).each(function(i){f=c.p.colModel[i].name;if(f!=="cb"&&f!=="subgrid"){if(d=="dirty"){if(b(this).hasClass("dirty-cell")){try{e[f]=b.unformat(this,{rowId:c.rows[h].id,colModel:c.p.colModel[i]},i)}catch(g){e[f]=b.jgrid.htmlDecode(b(this).html())}}}else{try{e[f]=b.unformat(this,{rowId:c.rows[h].id,colModel:c.p.colModel[i]},i)}catch(g){e[f]=b.jgrid.htmlDecode(b(this).html())}}}});e.id=this.id;a.push(e)}})});return a}})})(jQuery);