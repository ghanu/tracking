(function(b){b.jgrid.extend({setTreeNode:function(a,d){return this.each(function(){var o=this;if(!o.grid||!o.p.treeGrid){return}var x=o.p.expColInd;var c=o.p.treeReader.expanded_field;var q=o.p.treeReader.leaf_field;var r=o.p.treeReader.level_field;d.level=a[r];if(o.p.treeGridModel=="nested"){var t=a[o.p.treeReader.left_field],u=a[o.p.treeReader.right_field];if(!a[q]){a[q]=(parseInt(u,10)===parseInt(t,10)+1)?"true":"false"}}else{}var w=parseInt(a[r],10),p,v;if(o.p.tree_root_level===0){p=w+1;v=w}else{p=w;v=w-1}var s="<div class='tree-wrap tree-wrap-"+o.p.direction+"' style='width:"+(p*18)+"px;'>";s+="<div style='"+(o.p.direction=="rtl"?"right:":"left:")+(v*18)+"px;' class='ui-icon ";if(a[q]=="true"||a[q]===true){s+=o.p.treeIcons.leaf+" tree-leaf'";a[q]=true;a[c]=false}else{if(a[c]=="true"||a[c]===true){s+=o.p.treeIcons.minus+" tree-minus treeclick'";a[c]=true}else{s+=o.p.treeIcons.plus+" tree-plus treeclick'";a[c]=false}a[q]=false}s+="</div></div>";if(!o.p.loadonce){a[o.p.localReader.id]=d.id;o.p.data.push(a);o.p._index[d.id]=o.p.data.length-1}if(parseInt(a[r],10)!==parseInt(o.p.tree_root_level,10)){if(!b(o).jqGrid("isVisibleNode",a)){b(d).css("display","none")}}b("td:eq("+x+")",d).wrapInner("<span></span>").prepend(s);b(".treeclick",d).bind("click",function(g){var h=g.target||g.srcElement,e=b(h,o.rows).closest("tr.jqgrow")[0].id,f=o.p._index[e],i=o.p.treeReader.leaf_field,j=o.p.treeReader.expanded_field;if(!o.p.data[f][i]){if(o.p.data[f][j]){b(o).jqGrid("collapseRow",o.p.data[f]);b(o).jqGrid("collapseNode",o.p.data[f])}else{b(o).jqGrid("expandRow",o.p.data[f]);b(o).jqGrid("expandNode",o.p.data[f])}}return false});if(o.p.ExpandColClick===true){b("span",d).css("cursor","pointer").bind("click",function(g){var h=g.target||g.srcElement,e=b(h,o.rows).closest("tr.jqgrow")[0].id,f=o.p._index[e],i=o.p.treeReader.leaf_field,j=o.p.treeReader.expanded_field;if(!o.p.data[f][i]){if(o.p.data[f][j]){b(o).jqGrid("collapseRow",o.p.data[f]);b(o).jqGrid("collapseNode",o.p.data[f])}else{b(o).jqGrid("expandRow",o.p.data[f]);b(o).jqGrid("expandNode",o.p.data[f])}}b(o).jqGrid("setSelection",e);return false})}})},setTreeGrid:function(){return this.each(function(){var f=this,g=0,a;if(!f.p.treeGrid){return}if(!f.p.treedatatype){b.extend(f.p,{treedatatype:f.p.datatype})}f.p.subGrid=false;f.p.altRows=false;f.p.pgbuttons=false;f.p.pginput=false;f.p.multiselect=false;f.p.rowList=[];a="ui-icon-triangle-1-"+(f.p.direction=="rtl"?"w":"e");f.p.treeIcons=b.extend({plus:a,minus:"ui-icon-triangle-1-s",leaf:"ui-icon-radio-off"},f.p.treeIcons||{});if(f.p.treeGridModel=="nested"){f.p.treeReader=b.extend({level_field:"level",left_field:"lft",right_field:"rgt",leaf_field:"isLeaf",expanded_field:"expanded"},f.p.treeReader)}else{if(f.p.treeGridModel=="adjacency"){f.p.treeReader=b.extend({level_field:"level",parent_id_field:"parent",leaf_field:"isLeaf",expanded_field:"expanded"},f.p.treeReader)}}for(var h in f.p.colModel){if(f.p.colModel.hasOwnProperty(h)){if(f.p.colModel[h].name==f.p.ExpandColumn){f.p.expColInd=g;break}g++}}if(!f.p.expColInd){f.p.expColInd=0}b.each(f.p.treeReader,function(d,c){if(c){f.p.colNames.push(c);f.p.colModel.push({name:c,width:1,hidden:true,sortable:false,resizable:false,hidedlg:true,editable:true,search:false})}})})},expandRow:function(a){this.each(function(){var f=this;if(!f.grid||!f.p.treeGrid){return}var g=b(f).jqGrid("getNodeChildren",a),h=f.p.treeReader.expanded_field;b(g).each(function(d){var c=b.jgrid.getAccessor(this,f.p.localReader.id);b("#"+c,f.grid.bDiv).css("display","");if(this[h]){b(f).jqGrid("expandRow",this)}})})},collapseRow:function(a){this.each(function(){var f=this;if(!f.grid||!f.p.treeGrid){return}var g=b(f).jqGrid("getNodeChildren",a),h=f.p.treeReader.expanded_field;b(g).each(function(d){var c=b.jgrid.getAccessor(this,f.p.localReader.id);b("#"+c,f.grid.bDiv).css("display","none");if(this[h]){b(f).jqGrid("collapseRow",this)}})})},getRootNodes:function(){var a=[];this.each(function(){var f=this;if(!f.grid||!f.p.treeGrid){return}switch(f.p.treeGridModel){case"nested":var g=f.p.treeReader.level_field;b(f.p.data).each(function(c){if(parseInt(this[g],10)===parseInt(f.p.tree_root_level,10)){a.push(this)}});break;case"adjacency":var h=f.p.treeReader.parent_id_field;b(f.p.data).each(function(c){if(this[h]===null||String(this[h]).toLowerCase()=="null"){a.push(this)}});break}});return a},getNodeDepth:function(d){var a=null;this.each(function(){if(!this.grid||!this.p.treeGrid){return}var c=this;switch(c.p.treeGridModel){case"nested":var f=c.p.treeReader.level_field;a=parseInt(d[f],10)-parseInt(c.p.tree_root_level,10);break;case"adjacency":a=b(c).jqGrid("getNodeAncestors",d).length;break}});return a},getNodeParent:function(d){var a=null;this.each(function(){var s=this;if(!s.grid||!s.p.treeGrid){return}switch(s.p.treeGridModel){case"nested":var t=s.p.treeReader.left_field,n=s.p.treeReader.right_field,r=s.p.treeReader.level_field,o=parseInt(d[t],10),p=parseInt(d[n],10),m=parseInt(d[r],10);b(this.p.data).each(function(){if(parseInt(this[r],10)===m-1&&parseInt(this[t],10)<o&&parseInt(this[n],10)>p){a=this;return false}});break;case"adjacency":var q=s.p.treeReader.parent_id_field,c=s.p.localReader.id;b(this.p.data).each(function(f,e){if(this[c]==d[q]){a=this;return false}});break}});return a},getNodeChildren:function(d){var a=[];this.each(function(){var s=this;if(!s.grid||!s.p.treeGrid){return}switch(s.p.treeGridModel){case"nested":var t=s.p.treeReader.left_field,n=s.p.treeReader.right_field,r=s.p.treeReader.level_field,o=parseInt(d[t],10),p=parseInt(d[n],10),m=parseInt(d[r],10);b(this.p.data).each(function(e){if(parseInt(this[r],10)===m+1&&parseInt(this[t],10)>o&&parseInt(this[n],10)<p){a.push(this)}});break;case"adjacency":var q=s.p.treeReader.parent_id_field,c=s.p.localReader.id;b(this.p.data).each(function(f,e){if(this[q]==d[c]){a.push(this)}});break}});return a},getFullTreeNode:function(d){var a=[];this.each(function(){var c=this,v;if(!c.grid||!c.p.treeGrid){return}switch(c.p.treeGridModel){case"nested":var n=c.p.treeReader.left_field,q=c.p.treeReader.right_field,u=c.p.treeReader.level_field,r=parseInt(d[n],10),s=parseInt(d[q],10),p=parseInt(d[u],10);b(this.p.data).each(function(e){if(parseInt(this[u],10)>=p&&parseInt(this[n],10)>=r&&parseInt(this[n],10)<=s){a.push(this)}});break;case"adjacency":a.push(d);var t=c.p.treeReader.parent_id_field,o=c.p.localReader.id;b(this.p.data).each(function(e){v=a.length;for(e=0;e<v;e++){if(a[e][o]==this[t]){a.push(this);break}}});break}});return a},getNodeAncestors:function(d){var a=[];this.each(function(){if(!this.grid||!this.p.treeGrid){return}var c=b(this).jqGrid("getNodeParent",d);while(c){a.push(c);c=b(this).jqGrid("getNodeParent",c)}});return a},isVisibleNode:function(d){var a=true;this.each(function(){var c=this;if(!c.grid||!c.p.treeGrid){return}var g=b(c).jqGrid("getNodeAncestors",d),h=c.p.treeReader.expanded_field;b(g).each(function(){a=a&&this[h];if(!a){return false}})});return a},isNodeLoaded:function(d){var a;this.each(function(){var c=this;if(!c.grid||!c.p.treeGrid){return}var f=c.p.treeReader.leaf_field;if(d.loaded!==undefined){a=d.loaded}else{if(d[f]||b(c).jqGrid("getNodeChildren",d).length>0){a=true}else{a=false}}});return a},expandNode:function(a){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var h=this.p.treeReader.expanded_field;if(!a[h]){var g=b.jgrid.getAccessor(a,this.p.localReader.id);var i=b("#"+g,this.grid.bDiv)[0];var j=this.p._index[g];if(b(this).jqGrid("isNodeLoaded",this.p.data[j])){a[h]=true;b("div.treeclick",i).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus")}else{a[h]=true;b("div.treeclick",i).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus");this.p.treeANode=i.rowIndex;this.p.datatype=this.p.treedatatype;if(this.p.treeGridModel=="nested"){b(this).jqGrid("setGridParam",{postData:{nodeid:g,n_left:a.lft,n_right:a.rgt,n_level:a.level}})}else{b(this).jqGrid("setGridParam",{postData:{nodeid:g,parentid:a.parent_id,n_level:a.level}})}b(this).trigger("reloadGrid");if(this.p.treeGridModel=="nested"){b(this).jqGrid("setGridParam",{postData:{nodeid:"",n_left:"",n_right:"",n_level:""}})}else{b(this).jqGrid("setGridParam",{postData:{nodeid:"",parentid:"",n_level:""}})}}}})},collapseNode:function(a){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}if(a.expanded){a.expanded=false;var e=b.jgrid.getAccessor(a,this.p.localReader.id);var f=b("#"+e,this.grid.bDiv)[0];b("div.treeclick",f).removeClass(this.p.treeIcons.minus+" tree-minus").addClass(this.p.treeIcons.plus+" tree-plus")}})},SortTree:function(f,h,a,g){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var e,o,r,q=[],p=this,c,d,i=b(this).jqGrid("getRootNodes");c=b.jgrid.from(i);c.orderBy(f,h,a,g);d=c.select();for(e=0,o=d.length;e<o;e++){r=d[e];q.push(r);b(this).jqGrid("collectChildrenSortTree",q,r,f,h,a,g)}b.each(q,function(k,m){var l=b.jgrid.getAccessor(this,p.p.localReader.id);if(k===0){var j=b("#"+l,p.grid.bDiv);b("td",j).each(function(n){b(this).css("width",p.grid.headers[n].width+"px")});p.grid.cols=j[0].cells}b("tbody",p.grid.bDiv).append(b("#"+l,p.grid.bDiv))});c=null;d=null;q=null})},collectChildrenSortTree:function(l,i,h,k,a,j){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var f,n,d,e,c,g;e=b(this).jqGrid("getNodeChildren",i);c=b.jgrid.from(e);c.orderBy(h,k,k,a,j);g=c.select();for(f=0,n=g.length;f<n;f++){d=g[f];l.push(d);b(this).jqGrid("collectChildrenSortTree",l,d,h,k,a,j)}})},setTreeRow:function(h,g){var a,f=false;this.each(function(){var c=this;if(!c.grid||!c.p.treeGrid){return}f=b(c).jqGrid("setRowData",h,g)});return f},delTreeNode:function(a){return this.each(function(){var g=this;if(!g.grid||!g.p.treeGrid){return}var i=b(g).jqGrid("getInd",a,true);if(i){var h=b(g).jqGrid("getNodeChildren",i);if(h.length>0){for(var j=0;j<h.length;j++){b(g).jqGrid("delRowData",h[j].id)}}b(g).jqGrid("delRowData",i.id)}})}})})(jQuery);